<%- include('partials/header', { pageName: 'profile' }) %>

<div class="report-container">
    <!-- Sticky Side Navigation -->
    <aside class="report-nav">
        <h4><i class="fa-solid fa-list-ul"></i> Report Sections</h4>
        <ul id="report-nav-list">
            <li><a href="#section-summary">Summary & Actions</a></li>
            <li><a href="#section-graph">Relationship Graph</a></li>
            <% if (profile.scrapesAttempted.includes('github')) { %>
                <li><a href="#section-github">GitHub</a></li>
            <% } %>
            <% if (profile.scrapesAttempted.includes('twitter')) { %>
                <li><a href="#section-twitter">Twitter (X)</a></li>
            <% } %>
            <% if (profile.scrapesAttempted.includes('instagram')) { %>
                <li><a href="#section-instagram">Instagram</a></li>
            <% } %>
            <% if (profile.extractedEntities && Object.values(profile.extractedEntities).some(arr => arr && arr.length > 0)) { %>
                <li><a href="#section-entities">AI-Extracted Entities</a></li>
            <% } %>
            <% if (profile.googleDorks && Object.keys(profile.googleDorks).length > 0) { %>
                <li><a href="#section-leads">Investigation Leads</a></li>
            <% } %>
        </ul>
    </aside>

    <!-- Main Report Content -->
    <div class="report-content">
        <div class="profile-header">
            <h2>Report for: <span class="data-font"><%= profile.primaryUsername %></span></h2>
            <p>Generated on <%= moment(profile.reconDate).format('MMMM Do YYYY, h:mm:ss a') %></p>
        </div>

        <!-- Summary & Actions Card -->
        <div class="card" id="section-summary">
            <h3><i class="fa-solid fa-circle-info"></i> Summary & Actions</h3>
            <div class="summary-grid">
                <div class="summary-item">
                    <h4>Risk Score</h4>
                    <% if (profile.riskScore && profile.riskScore.score !== undefined) { %>
                        <span class="risk-score <%= profile.riskScore.label.toLowerCase() %>">
                            <%= profile.riskScore.score %> / 100 (<%= profile.riskScore.label %>)
                        </span>
                    <% } else { %>
                        <p class="no-results">N/A</p>
                    <% } %>
                </div>
                <div class="summary-item">
                    <h4>Found Profiles</h4>
                    <span class="summary-stat"><%= profile.usernameResults.length %></span>
                </div>
                <div class="summary-item">
                    <h4>Monitoring Status</h4>
                    <span class="summary-stat <%= profile.isMonitoring ? 'active' : '' %>">
                        <%= profile.isMonitoring ? 'ACTIVE' : 'INACTIVE' %>
                    </span>
                </div>
            </div>
            <div class="action-buttons">
                <button class="button-link" data-action="export-json"><i class="fa-solid fa-file-arrow-down"></i> JSON</button>
                <button class="button-link" data-action="export-pdf"><i class="fa-solid fa-file-pdf"></i> PDF</button>
                <button class="button-link" data-action="view-history"><i class="fa-solid fa-timeline"></i> History</button>
                <button id="monitor-btn" class="button-link" data-profile-id="<%= profile._id %>" <%= profile.isMonitoring ? 'disabled' : '' %>>
                    <i class="fa-solid fa-bell"></i> <%= profile.isMonitoring ? 'Monitoring' : 'Monitor' %>
                </button>
                <button class="button-link danger" data-action="hunt-leaks"><i class="fa-solid fa-user-secret"></i> Hunt Leaks</button>
                <a href="/profile/intermediate/<%= profile._id %>" class="button-link"><i class="fa-solid fa-magnifying-glass-plus"></i> Scrape More</a>
                <a href="/" class="button-link secondary"><i class="fa-solid fa-house"></i> New Search</a>

            </div>
        </div>

        <!-- Relationship Graph Card -->
        <div class="card" id="section-graph">
            <h3><i class="fa-solid fa-circle-nodes"></i> Relationship Graph</h3>
            <div id="relationship-graph" data-graph-data='<%- graphData %>'></div>
        </div>

        <!-- Platform Cards -->
        <% const platforms = { github: 'GitHub', twitter: 'Twitter (X)', instagram: 'Instagram' }; %>
        <% for(const [key, name] of Object.entries(platforms)) { %>
            <% if (profile.scrapesAttempted.includes(key)) { %>
                <div class="card" id="section-<%= key %>">
                    <h3><i class="fa-brands fa-<%= key %>"></i> <%= name %></h3>
                    <% let data;
                if (key === 'github') {
                    data = profile.gitHubData; // Use correct camelCase for GitHub
                } else {
                    data = profile[key + 'Data'];
                } %>
                    <% if (data && !data.error && (data.bio_text || data.location || data.org || data.followers_count || data.display_name)) { %>
                        <div class="profile-data-grid">
                            <% if (data.profile_pic_url) { %>
                                <div class="profile-picture-container">
                                    <img src="<%= data.profile_pic_url %>" alt="<%= name %> Profile Picture" class="profile-picture">
                                    <button class="analyze-image-btn" data-image-url="<%= data.profile_pic_url %>">
                                        <i class="fa-solid fa-camera-retro"></i> Analyze
                                    </button>
                                </div>
                            <% } %>
                            <div class="profile-details">
                                <p><strong>URL:</strong> <a href="<%= data.url %>" target="_blank"><%= data.url %></a></p>
                                <% if(data.display_name) { %><p><strong>Name:</strong> <%= data.display_name %></p><% } %>
                                <% if(data.username_handle) { %><p><strong>Handle:</strong> <span class="data-font"><%= data.username_handle %></span></p><% } %>
                                <p><strong>Bio:</strong> <pre class="bio-box"><%= data.bio_text || 'N/A' %></pre></p>
                                <% if(data.location) { %><p><strong>Location:</strong> <%= data.location %></p><% } %>
                                <% if(data.website) { %>
                                    <p><strong>Website:</strong> <a href="<%= data.website %>" target="_blank"><%= data.website %></a>
                                    <button class="analyze-domain-btn" data-website-url="<%= data.website %>"><i class="fa-solid fa-network-wired"></i></button>
                                    </p>
                                <% } %>
                                <% if(data.followers_count) { %><p><strong>Followers:</strong> <%= data.followers_count %></p><% } %>
                                <% if(data.following_count) { %><p><strong>Following:</strong> <%= data.following_count %></p><% } %>
                                <% if(data.join_date) { %><p><strong>Joined:</strong> <%= data.join_date %></p><% } %>
                                <% if(data.verified_badge !== undefined) { %><p><strong>Verified:</strong> <%= data.verified_badge ? 'Yes' : 'No' %></p><% } %>
                            </div>
                        </div>
                    <% } else { %>
                        <p class="no-results">Scrape was run, but no detailed public information was found.</p>
                    <% } %>
                </div>
            <% } %>
        <% } %>

        <!-- AI-Extracted Entities Card -->
        <% if (profile.enrichedEntities && Object.values(profile.enrichedEntities).some(arr => arr && arr.length > 0)) { %>
            <div class="card" id="section-entities">
                <h3><i class="fa-solid fa-brain"></i> AI-Extracted Entities</h3>
                <div class="entity-grid">
                    <% for (const [type, list] of Object.entries(profile.enrichedEntities)) { %>
                        <% if (list && list.length > 0) { %>
                            <div class="entity-category">
                                <h4><%= type %></h4>
                                <ul class="entity-list">
                                    <% list.forEach(item => { %>
                                        <li>
                                            <span class="data-font"><%= item.text %></span>
                                            <% if (item.isEnriched) { %>
                                                <span class="enriched-info" title="<%= item.info %>"><i class="fa-solid fa-check-circle"></i></span>
                                            <% } %>
                                        </li>
                                    <% }) %>
                                </ul>
                            </div>
                        <% } %>
                    <% } %>
                </div>
            </div>
        <% } %>

        <!-- Investigation Leads Card -->
        <% const hasDorks = profile.googleDorks && (profile.googleDorks.username_dorks?.length || Object.keys(profile.googleDorks.entity_dorks || {}).length); %>
        <% if (hasDorks) { %>
            <div class="card" id="section-leads">
                <h3><i class="fa-brands fa-google"></i> Investigation Leads (Google Dorks)</h3>
                <ul class="dork-list entity-list">
                <% profile.googleDorks.username_dorks.forEach(dork => { %>
                    <li><a href="<%= dork.url %>" target="_blank" rel="noopener noreferrer"><%= dork.text %> <i class="fa-solid fa-arrow-up-right-from-square fa-xs"></i></a></li>
                <% }) %>
                <% for (const [entity, dorks] of Object.entries(profile.googleDorks.entity_dorks || {})) { %>
                    <% dorks.forEach(dork => { %>
                         <li><a href="<%= dork.url %>" target="_blank" rel="noopener noreferrer"><strong>[<%= entity %>]</strong>: <%= dork.text %> <i class="fa-solid fa-arrow-up-right-from-square fa-xs"></i></a></li>
                    <% }) %>
                <% } %>
                </ul>
            </div>
        <% } %>
    </div>
</div>

<%- include('partials/footer') %>