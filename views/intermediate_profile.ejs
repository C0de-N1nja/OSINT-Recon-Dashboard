<%- include('partials/header', { pageName: 'intermediate' }) %>

    <div class="profile-header">
        <h2>Recon Profile: <span class="data-font">
                <%= profile.primaryUsername %>
            </span></h2>
        <p class="step-indicator">Step 2/3: Select Platforms for Deep Scraping</p>
    </div>

    <!-- Initial Scan Results -->
    <div class="card">
        <h3><i class="fa-solid fa-tower-broadcast"></i> Initial Scan Complete</h3>
        <p>Found <strong>
                <%= profile.usernameResults.length %>
            </strong> potential profiles. Select the desired platforms below to run a deep scrape for more intelligence.
        </p>
        <ul class="platform-list">
            <% profile.usernameResults.forEach(result=> { %>
                <li>
                    <i class="fa-solid fa-check icon-found"></i>
                    <strong>
                        <%= result.site %>:
                    </strong>
                    <a href="<%= result.url %>" target="_blank" rel="noopener noreferrer">
                        <%= result.url %>
                    </a>
                </li>
                <% }) %>
        </ul>
    </div>

    <!-- Scraping Selection Form -->
    <div class="card">
        <h3><i class="fa-solid fa-crosshairs"></i> Deep Scraping Options</h3>
        <form id="scrape-form" action="/recon/scrape" method="POST" class="scrape-form">
            <input type="hidden" name="profileId" value="<%= profile._id %>">

            <% const foundPlatforms=new Set(profile.usernameResults.map(p=> p.site.toLowerCase()));
                const availableScrapers = {
                github: { icon: 'fa-brands fa-github', name: 'GitHub' },
                twitter: { icon: 'fa-brands fa-twitter', name: 'Twitter (X)' },
                instagram: { icon: 'fa-brands fa-instagram', name: 'Instagram' }
                };
                %>

                <label class="checkbox-wrapper">
                    <strong>Select All Available</strong>
                    <input type="checkbox" id="select-all">
                    <span class="checkmark"></span>
                </label>
                <hr style="border-color: var(--color-border); margin: 1.5rem 0;">

                <% for (const [platform, data] of Object.entries(availableScrapers)) { %>
                    <% const isFound=foundPlatforms.has(platform); %>
                        <label class="checkbox-wrapper">
                            <span class="checkbox-label <%= isFound ? '' : 'disabled' %>">
                                <i class="<%= data.icon %>"></i>
                                <%= data.name %>
                            </span>
                            <input type="checkbox" name="platforms" value="<%= platform %>" id="<%= platform %>"
                                class="platform-checkbox" <%=isFound ? '' : 'disabled' %>>
                            <span class="checkmark"></span>
                        </label>
                        <% } %>

                            <div class="action-buttons">
                                <button type="submit" class="button-link">Run Deep Scrape</button>
                                <a href="/profile/<%= profile._id %>" class="button-link secondary">Skip & View
                                    Report</a>
                            </div>
        </form>
    </div>

    <%- include('partials/footer') %>